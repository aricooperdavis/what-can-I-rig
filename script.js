let deferredPrompt,views={derbyshire:{coords:[53.2,-1.78],zoom:9},scotland:{coords:[57.9,-5.17],zoom:7},yorkshire:{coords:[54.17,-2.19],zoom:10}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/what-can-I-rig/sw.js",{scope:"/what-can-I-rig/"});let installBtn=document.querySelector("#install"),installP=document.querySelector(".install");function removeRope(e){e.target.parentNode.remove()}function addRope(e){let t=ropeInput.cloneNode(!0);t.lastChild.disabled=!1,t.firstChild.value="",t.firstChild.onkeydown=handleTabs,addButton.parentNode.insertBefore(t,e.target??e);for(let e of document.getElementsByClassName("rope"))e.lastChild.onclick=removeRope;return t}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,installP.style.display="block",installBtn.addEventListener("click",e=>{deferredPrompt.prompt(),deferredPrompt.userChoice.then(e=>{deferredPrompt=null})})});let addButton=document.getElementById("add");function handleTabs(e){if("Tab"==e.code){let t=addRope(e.target.parentNode.nextElementSibling);e.preventDefault(),t.firstChild.focus()}}addButton.onclick=addRope;let ropeInput=document.getElementsByClassName("rope")[0];function showMap(){let e=L.map("map").setView([54.17,-2.19],10);return L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(e),e}ropeInput.onkeydown=handleTabs;let caveMap=showMap(),regionSel=document.getElementById("region"),region=new URLSearchParams(window.location.search).get("region")??"";function updateRegion(e){region=["yorkshire","derbyshire","scotland"].filter(t=>t==e.toLowerCase())[0]??"yorkshire",regionSel.value=region,caveMap.flyTo(views[region].coords,views[region].zoom)}updateRegion(region),regionSel.addEventListener("change",e=>updateRegion(e.target.value));let tableData=document.getElementById("data"),resetButton=document.getElementById("reset");resetButton.onclick=function(){for(let e of document.querySelectorAll(".rope"))e.lastChild.disabled?e.firstChild.value="":e.remove();tableData.innerHTML="",clearMap(),document.getElementById("join").checked=!1};let goButton=document.getElementById("go");function join_combs(e){function t(e){let t=[];for(var n=0;n<e.length-1;n++)for(var o=n+1;o<e.length;o++)t.push(e.slice(0,n).concat(e[n]+e[o],e.slice(n+1,o),e.slice(o+1)));return t}let n=t(e);return n.forEach(e=>{e.length>1&&t(e).forEach(e=>{n.push(e.sort().reverse())})}),n=Object.values(n.reduce((e,t)=>(e[JSON.stringify(t)]=t,e),{})),n}goButton.onclick=function(){let e=[];for(let t of document.getElementsByClassName("rope"))e.push(parseInt(t.firstChild.value));e=e.sort((e,t)=>t-e);let t=document.getElementById("join").checked;tableData.innerHTML="",clearMap(),fetch(`./pitchlengths/${region}.txt`).then(e=>e.text()).then(function(n){n=n.split("\n").filter(e=>!(e.startsWith("#")|e.length<3));for(let[o,r]of Object.entries(n.sort()))if(r=r.split(","),!(r.filter(e=>!e.includes("[")).length-1>e.length)){if(pitches=r.slice(1).filter(e=>!e.includes("[")).map(e=>parseInt(e.trim())).sort((e,t)=>e<t),pitches.every((t,n)=>t<=e[n])){let e=`<tr><td>${r[1].includes("[")?`<a href="https://www.openstreetmap.org/?mlat=${r[1].slice(1,-1)}&mlon=${r[2].slice(1,-1)}" target="_blank" title="View in Open Street Map">${r[0]}</a>`:r[0]}</td><td>${r.slice(1).filter(e=>!e.includes("[")).join(", ")||"Ropes in-situ"}</td></tr>`;tableData.insertAdjacentHTML("beforeend",e),displayOnMap(r,!1);continue}if(t)for(let[t,n]of Object.entries(join_combs(e)))if(pitches.every((e,t)=>e<=n[t])){let e=`<tr class="join"><td>${r[1].includes("[")?`<a href="https://www.openstreetmap.org/?mlat=${r[1].slice(1,-1)}&mlon=${r[2].slice(1,-1)}" target="_blank" title="View in Open Street Map">${r[0]}</a>`:r[0]}</td><td>${r.slice(1).filter(e=>!e.includes("[")).join(", ")||"Ropes in-situ"}</td></tr>`;tableData.insertAdjacentHTML("beforeend",e),displayOnMap(r,!0);break}}fitBounds()})};let markers=[],lost_count=document.getElementById("lost_count"),lost_message=document.getElementById("lost_message");function displayOnMap(e,t){if(e[1].includes("[")){let n=L.marker(e.slice(1,3).map(e=>parseFloat(e.slice(1,-1)))).addTo(caveMap);t||n._icon.classList.add("black"),n.bindPopup(`<a href="https://www.openstreetmap.org/?mlat=${e[1].slice(1,-1)}&mlon=${e[2].slice(1,-1)}" target="_blank" title="View in Open Street Map">${e[0]}</a>`),markers.push(n)}else lost_count.textContent=parseInt(lost_count.textContent)+1,lost_message.style.display="block"}function clearMap(){markers.forEach(e=>caveMap.removeLayer(e)),markers=[],lost_count.textContent="0",lost_message.style.display="none"}let group=null;function fitBounds(){markers.length>0&&(group=new L.featureGroup(markers),caveMap.flyToBounds(group.getBounds().pad(.1)))}